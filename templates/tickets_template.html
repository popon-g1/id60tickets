{% extends "base.html" %}

{% block title %}All Tickets - IT Support{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2 mb-0">
            <i class="bi bi-list-ul text-primary"></i> All Tickets
        </h1>
        <p class="text-muted">Manage and track all support requests</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('create_ticket') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New Ticket
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="site" class="form-label">Site</label>
                <select name="site" id="site" class="form-select">
                    <option value="all" {{ 'selected' if current_site == 'all' or not current_site }}>All Sites</option>
                    {% for site in sites %}
                        <option value="{{ site }}" {{ 'selected' if current_site == site }}>{{ site }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select name="status" id="status" class="form-select">
                    <option value="all" {{ 'selected' if current_status == 'all' or not current_status }}>All Status</option>
                    <option value="Open" {{ 'selected' if current_status == 'Open' }}>Open</option>
                    <option value="In Progress" {{ 'selected' if current_status == 'In Progress' }}>In Progress</option>
                    <option value="Resolved" {{ 'selected' if current_status == 'Resolved' }}>Resolved</option>
                    <option value="Closed" {{ 'selected' if current_status == 'Closed' }}>Closed</option>
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="search" class="form-label">Search</label>
                <input type="text" name="search" id="search" class="form-control" 
                       placeholder="Search tickets, descriptions, or senders..." 
                       value="{{ current_search }}">
            </div>
            
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search"></i> Filter
                    </button>
                </div>
            </div>
        </form>
        
        {% if current_site or current_status or current_search %}
        <div class="mt-3">
            <span class="text-muted me-2">Active filters:</span>
            {% if current_site and current_site != 'all' %}
                <span class="badge bg-info me-1">Site: {{ current_site }}</span>
            {% endif %}
            {% if current_status and current_status != 'all' %}
                <span class="badge bg-warning me-1">Status: {{ current_status }}</span>
            {% endif %}
            {% if current_search %}
                <span class="badge bg-secondary me-1">Search: "{{ current_search }}"</span>
            {% endif %}
            <a href="{{ url_for('tickets') }}" class="btn btn-sm btn-outline-secondary ms-2">
                <i class="bi bi-x-circle"></i> Clear
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Tickets Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-table"></i> 
            Tickets ({{ tickets|length }} found)
        </h5>
        
        <!-- Export buttons could go here -->
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                    data-bs-toggle="dropdown">
                <i class="bi bi-download"></i> Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportTableToCSV()">
                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print
                </a></li>
            </ul>
        </div>
    </div>
    
    <div class="card-body p-0">
        {% if tickets %}
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="ticketsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Ticket #</th>
                            <th>Site</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Sender</th>
                            <th>Created</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in tickets %}
                        <tr>
                            <td>
                                <a href="{{ url_for('ticket_detail', ticket_number=ticket.ticket_number) }}" 
                                   class="text-decoration-none fw-bold">
                                    {{ ticket.ticket_number }}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ ticket.site }}</span>
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 300px;" 
                                     title="{{ ticket.description }}">
                                    {{ ticket.description }}
                                </div>
                            </td>
                            <td>
                                {% set status_class = {
                                    'Open': 'danger',
                                    'In Progress': 'warning',
                                    'Resolved': 'success',
                                    'Closed': 'secondary'
                                } %}
                                <span class="badge bg-{{ status_class.get(ticket.status, 'primary') }}">
                                    {{ ticket.status }}
                                </span>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ ticket.sender or 'Anonymous' }}
                                </small>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {% if ticket.created_at %}
                                        {{ ticket.created_at.strftime('%m/%d/%y %H:%M') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {% if ticket.updated_at %}
                                        {{ ticket.updated_at.strftime('%m/%d/%y %H:%M') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('ticket_detail', ticket_number=ticket.ticket_number) }}" 
                                       class="btn btn-outline-primary btn-sm" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if ticket.status in ['Open', 'In Progress'] %}
                                    <button type="button" class="btn btn-outline-success btn-sm" 
                                            title="Quick Resolve" 
                                            onclick="quickUpdateStatus('{{ ticket.ticket_number }}', 'Resolved')">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h5 class="text-muted mt-3">No tickets found</h5>
                {% if current_site or current_status or current_search %}
                    <p class="text-muted">Try adjusting your search filters</p>
                    <a href="{{ url_for('tickets') }}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-counterclockwise"></i> Clear Filters
                    </a>
                {% else %}
                    <p class="text-muted">No support tickets have been created yet</p>
                    <a href="{{ url_for('create_ticket') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create First Ticket
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Quick status update
function quickUpdateStatus(ticketNumber, newStatus) {
    if (confirm(`Update ticket ${ticketNumber} to ${newStatus}?`)) {
        fetch(`/update_ticket/${ticketNumber}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `status=${encodeURIComponent(newStatus)}&csrf_token=${document.querySelector('[name=csrf_token]').value}`
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to update ticket');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating ticket');
        });
    }
}

// Export to CSV
function exportTableToCSV() {
    const table = document.getElementById('ticketsTable');
    const rows = table.querySelectorAll('tr');
    const csvData = [];
    
    // Get headers (exclude Actions column)
    const headers = Array.from(rows[0].querySelectorAll('th'))
        .slice(0, -1)
        .map(th => th.textContent.trim());
    csvData.push(headers.join(','));
    
    // Get data rows
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = Array.from(row.querySelectorAll('td'))
            .slice(0, -1)
            .map(td => {
                let text = td.textContent.trim();
                // Handle commas and quotes in CSV
                if (text.includes(',') || text.includes('"')) {
                    text = '"' + text.replace(/"/g, '""') + '"';
                }
                return text;
            });
        csvData.push(cells.join(','));
    }
    
    // Download CSV
    const blob = new Blob([csvData.join('\n')], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tickets_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Auto-submit form on filter change
document.getElementById('site').addEventListener('change', function() {
    this.form.submit();
});

document.getElementById('status').addEventListener('change', function() {
    this.form.submit();
});
</script>
{% endblock %}